# 虚拟客户端和服务端速度测试

## 概述

`speed_test` 是一个专门用于测试 Fast-TCP-VPN 网络传输性能的工具。它实现了虚拟客户端和虚拟服务端，**不使用 TUN 设备**，直接生成和消费数据包，用于纯网络层面的性能测试。

### 特点

- ✅ **无需 TUN 设备**: 跳过虚拟网络接口，直接测试网络传输性能
- ✅ **真实加密**: 使用 ChaCha20-Poly1305 加密，与实际 VPN 相同
- ✅ **真实网络**: 使用 Raw Socket 进行真实的网络传输
- ✅ **实时统计**: 每秒更新吞吐量、包速率等指标
- ✅ **本地/远程**: 支持本地回环测试和远程服务器测试

## 编译

```bash
cargo build --release --bin speed_test
```

编译后的二进制文件位于: `target/release/speed_test`

## 使用方法

### 服务端

```bash
sudo ./target/release/speed_test server [port] [duration_secs]
```

**参数:**
- `port`: 监听端口 (默认: 9000)
- `duration_secs`: 测试时长(秒) (默认: 10)

**示例:**
```bash
# 监听 9000 端口，运行 30 秒
sudo ./target/release/speed_test server 9000 30
```

### 客户端

```bash
sudo ./target/release/speed_test client <server_ip> [port] [duration_secs] [packet_size]
```

**参数:**
- `server_ip`: 服务器 IP 地址 (必需)
- `port`: 服务器端口 (默认: 9000)
- `duration_secs`: 测试时长(秒) (默认: 10)
- `packet_size`: 数据包大小(字节) (默认: 1400)

**示例:**
```bash
# 连接本地服务器，测试 10 秒，包大小 1400 字节
sudo ./target/release/speed_test client 127.0.0.1 9000 10 1400

# 连接远程服务器，测试 30 秒，包大小 1200 字节
sudo ./target/release/speed_test client 38.175.192.236 9000 30 1200
```

## 快速测试脚本

项目提供了一个便捷的测试脚本 `test_speed.sh`，可以自动启动服务端和客户端进行本地测试：

```bash
sudo ./test_speed.sh
```

## 测试结果示例

### 本地回环测试 (127.0.0.1)

```
=== 客户端测试结果 ===
测试时长: 10.00秒
发送包数: 534200
原始数据: 788.48 MB
明文数据: 747.88 MB
发送错误: 0
包速率: 53410.91 pps
吞吐量: 630.68 Mbps (原始)
吞吐量: 598.20 Mbps (明文)
加密开销: 5.43%
```

**性能指标:**
- **吞吐量**: ~630 Mbps (加密后的数据)
- **包速率**: ~53,000 pps (每秒包数)
- **加密开销**: ~5.4% (ChaCha20-Poly1305 的开销)

### 远程测试 (跨网络)

远程测试的性能取决于网络带宽和延迟。典型结果:
- **千兆网络**: 500-900 Mbps
- **百兆网络**: 80-95 Mbps
- **跨国网络**: 取决于带宽和丢包率

## 工作原理

### 虚拟客户端

1. **生成测试数据**: 创建模拟的 IP 包 (UDP 协议)
2. **加密**: 使用 ChaCha20-Poly1305 加密数据
3. **封装**: 将加密数据封装到外层 TCP 包中
4. **发送**: 通过 Raw Socket 发送到服务器
5. **统计**: 实时统计发送速率和吞吐量

### 虚拟服务端

1. **接收**: 通过 Raw Socket 接收数据包
2. **解析**: 解析外层 TCP 包
3. **解密**: 使用 ChaCha20-Poly1305 解密数据
4. **验证**: 验证解密后的 IP 包格式
5. **统计**: 实时统计接收速率和吞吐量

### 与真实 VPN 的区别

| 特性 | 真实 VPN | 速度测试 |
|------|---------|---------|
| TUN 设备 | ✅ 使用 | ❌ 跳过 |
| 网络传输 | ✅ Raw Socket | ✅ Raw Socket |
| 加密/解密 | ✅ ChaCha20 | ✅ ChaCha20 |
| 数据封装 | ✅ 完整封装 | ✅ 完整封装 |
| 路由配置 | ✅ 需要 | ❌ 不需要 |
| 应用流量 | ✅ 真实应用 | ❌ 模拟数据 |

**速度测试的优势:**
- 更快的部署 (无需配置 TUN 和路由)
- 纯粹的网络性能测试 (排除应用层干扰)
- 适合快速验证网络质量和加密性能

## 性能调优

### 调整包大小

较大的包可以提高吞吐量，但可能增加丢包率:

```bash
# 小包 (适合高丢包网络)
sudo ./target/release/speed_test client 127.0.0.1 9000 10 800

# 标准包 (平衡)
sudo ./target/release/speed_test client 127.0.0.1 9000 10 1400

# 大包 (适合稳定网络)
sudo ./target/release/speed_test client 127.0.0.1 9000 10 8000
```

### 调整测试时长

更长的测试时间可以获得更准确的平均值:

```bash
# 短测试 (快速验证)
sudo ./target/release/speed_test client 127.0.0.1 9000 5 1400

# 标准测试
sudo ./target/release/speed_test client 127.0.0.1 9000 10 1400

# 长测试 (稳定性测试)
sudo ./target/release/speed_test client 127.0.0.1 9000 60 1400
```

## 注意事项

1. **需要 root 权限**: Raw Socket 需要 root 权限
2. **防火墙**: 确保端口未被防火墙阻止
3. **本地测试**: 本地回环测试性能最高，但不代表真实网络性能
4. **CPU 限制**: 在高速网络上，CPU 可能成为瓶颈
5. **网络质量**: 远程测试受网络带宽、延迟、丢包率影响

## 故障排查

### 权限错误
```
[ERROR] 权限不足，请使用 sudo 运行
```
**解决**: 使用 `sudo` 运行命令

### 连接超时
```
[ERROR] 接收错误: Timeout
```
**可能原因:**
- 服务端未启动
- 防火墙阻止
- IP 地址或端口错误

### 加密失败
```
[ERROR] 加密失败: ...
```
**可能原因:**
- PSK 不匹配 (客户端和服务端必须使用相同的密钥)
- 内存不足

## 与其他测试工具对比

| 工具 | 用途 | 优势 | 劣势 |
|------|------|------|------|
| `speed_test` | VPN 性能 | 真实加密、完整封装 | 需要 root |
| `iperf3` | 网络带宽 | 简单、标准 | 无加密 |
| `raw_socket_test` | 物理层 | 最底层测试 | 无加密、无封装 |
| 真实 VPN | 端到端 | 最真实 | 配置复杂 |

## 性能基准

在不同硬件上的典型性能 (本地回环):

| CPU | 吞吐量 | 包速率 |
|-----|--------|--------|
| Intel i5 (4核) | ~500 Mbps | ~40,000 pps |
| Intel i7 (8核) | ~800 Mbps | ~60,000 pps |
| AMD Ryzen 5 | ~600 Mbps | ~50,000 pps |
| 服务器 (Xeon) | ~1000+ Mbps | ~80,000+ pps |

**注意**: 实际性能取决于 CPU 频率、内存速度、网络接口等因素。

## 下一步

完成速度测试后，可以:
1. 使用真实 VPN 进行端到端测试
2. 在不同网络环境下测试 (局域网、跨国网络)
3. 测试丢包模拟环境 (使用 `tc netem`)
4. 进行长时间稳定性测试

## 相关文档

- [TODO.md](TODO.md) - 项目开发计划
- [README.md](README.md) - 项目总体介绍
- [client.toml](client.toml) - 客户端配置示例
