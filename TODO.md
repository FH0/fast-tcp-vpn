# Fast-TCP-VPN 开发任务清单

> **设计原则**: 低耦合、高内聚、可独立测试
>
> **核心特性**: 多倍发包 + 不回退 + Raw TCP 传输

---

## 模块依赖关系

```
┌─────────────────────────────────────────────────────────────────┐
│                        应用层 (Application)                      │
│   server.rs ◄──────────────────────────────► client.rs          │
│       │                                          │               │
│       └──────────────┬───────────────────────────┘               │
│                      ▼                                           │
├─────────────────────────────────────────────────────────────────┤
│                        领域层 (Domain)                           │
│                                                                  │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐           │
│   │   Tunnel    │◄──│ Reliability │◄──│  Transport  │           │
│   │  (隧道管理)  │   │  (可靠性)   │   │  (传输协议) │           │
│   └─────────────┘   └─────────────┘   └─────────────┘           │
│         │                 │                  │                   │
│         ▼                 ▼                  ▼                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                    Traits (接口抽象)                     │   │
│   │  PacketSender, PacketReceiver, TunDevice, Encryptor     │   │
│   └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
├──────────────────────────────┼──────────────────────────────────┤
│                        基础设施层 (Infrastructure)               │
│                              ▼                                   │
│   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐   │
│   │ RawSocket │  │ TunLinux  │  │ TunWindows│  │  Crypto   │   │
│   │  (pnet)   │  │   (tun)   │  │ (wintun)  │  │ (chacha)  │   │
│   └───────────┘  └───────────┘  └───────────┘  └───────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

**解耦策略**:
- 领域层通过 **Trait** 依赖基础设施，不直接依赖具体实现
- 每个模块可通过 **Mock** 实现独立测试
- 模块间通过 **消息/事件** 通信，避免直接调用

---

## Phase 1: 基础设施层

### 1.1 Raw TCP 数据包处理
- [x] **1.1.1** 定义 `Packet` 值对象 (IP头 + TCP头 + Payload)
- [x] **1.1.2** 实现 TCP 包构造器 (设置 seq/ack/flags)
- [x] **1.1.3** 实现 TCP 包解析器
- [x] **1.1.4** 实现校验和计算 (IP + TCP checksum)
- [x] **1.1.5** 单元测试: 构造/解析往返测试
- [x] **1.1.6** 单元测试: 校验和正确性

### 1.2 Raw Socket 抽象
- [ ] **1.2.1** 定义 `trait PacketSender` 接口
- [ ] **1.2.2** 定义 `trait PacketReceiver` 接口
- [ ] **1.2.3** 实现 Linux Raw Socket (基于 pnet)
- [ ] **1.2.4** 实现 Mock Socket (用于测试)
- [ ] **1.2.5** 集成测试: 发送/接收真实 TCP SYN

### 1.3 TUN 设备抽象
- [ ] **1.3.1** 定义 `trait TunDevice` 接口 (read/write IP包)
- [ ] **1.3.2** 实现 Linux TUN (基于 tun crate)
- [ ] **1.3.3** 实现 Windows Wintun (基于 wintun crate)
- [ ] **1.3.4** 实现 Mock TUN (用于测试)
- [ ] **1.3.5** 集成测试: Linux TUN 读写
- [ ] **1.3.6** 集成测试: Windows Wintun 读写

### 1.4 加密模块
- [ ] **1.4.1** 定义 `trait Encryptor` 接口 (encrypt/decrypt)
- [ ] **1.4.2** 实现 ChaCha20-Poly1305 加密器
- [ ] **1.4.3** 实现 Noop 加密器 (用于调试)
- [ ] **1.4.4** 单元测试: 加解密往返
- [ ] **1.4.5** 单元测试: 密文篡改检测

---

## Phase 2: 传输层领域

### 2.1 连接状态机
- [ ] **2.1.1** 定义连接状态枚举 (Closed/SynSent/Established/...)
- [ ] **2.1.2** 实现状态转换逻辑 (纯函数，无副作用)
- [ ] **2.1.3** 单元测试: 正常握手流程
- [ ] **2.1.4** 单元测试: 异常状态处理

### 2.2 序列号管理
- [ ] **2.2.1** 实现序列号生成器 (ISN)
- [ ] **2.2.2** 实现序列号比较 (处理回绕)
- [ ] **2.2.3** 单元测试: 序列号回绕边界

### 2.3 连接实体
- [ ] **2.3.1** 定义 `Connection` 实体 (状态 + 序列号 + 对端信息)
- [ ] **2.3.2** 实现连接建立方法 (主动/被动)
- [ ] **2.3.3** 实现数据发送方法
- [ ] **2.3.4** 实现连接关闭方法
- [ ] **2.3.5** 集成测试: 完整连接生命周期

### 2.4 数据分片
- [ ] **2.4.1** 实现 MTU 分片器
- [ ] **2.4.2** 实现分片重组器
- [ ] **2.4.3** 单元测试: 分片/重组往返

---

## Phase 3: 可靠性领域 (核心差异化)

### 3.1 多倍发包策略
- [ ] **3.1.1** 定义 `trait RedundancyStrategy` 接口
- [ ] **3.1.2** 实现固定倍数策略 (2x/3x)
- [ ] **3.1.3** 实现自适应策略 (根据丢包率调整)
- [ ] **3.1.4** 单元测试: 冗余包生成
- [ ] **3.1.5** 单元测试: 策略切换

### 3.2 去重服务
- [ ] **3.2.1** 实现基于序列号的去重器
- [ ] **3.2.2** 实现滑动窗口去重 (处理乱序)
- [ ] **3.2.3** 实现去重缓存过期清理
- [ ] **3.2.4** 单元测试: 重复包过滤
- [ ] **3.2.5** 单元测试: 乱序包处理
- [ ] **3.2.6** 单元测试: 内存不泄漏

### 3.3 无回退传输
- [ ] **3.3.1** 实现发送窗口 (不因丢包收缩)
- [ ] **3.3.2** 实现固定发送速率控制
- [ ] **3.3.3** 压力测试: 模拟 30% 丢包

### 3.4 包缓冲与重排
- [ ] **3.4.1** 实现接收缓冲区
- [ ] **3.4.2** 实现乱序重排
- [ ] **3.4.3** 实现超时交付 (避免无限等待)
- [ ] **3.4.4** 单元测试: 乱序重排正确性

---

## Phase 4: 隧道领域

### 4.1 会话管理
- [ ] **4.1.1** 定义 `Session` 实体
- [ ] **4.1.2** 实现会话创建/销毁
- [ ] **4.1.3** 实现会话认证 (预共享密钥)
- [ ] **4.1.4** 实现心跳保活
- [ ] **4.1.5** 单元测试: 会话生命周期
- [ ] **4.1.6** 单元测试: 认证失败处理

### 4.2 虚拟 IP 管理
- [ ] **4.2.1** 定义 `VirtualIP` 值对象
- [ ] **4.2.2** 实现 IP 池分配器
- [ ] **4.2.3** 实现 IP 回收
- [ ] **4.2.4** 单元测试: IP 分配/回收
- [ ] **4.2.5** 单元测试: IP 池耗尽处理

### 4.3 路由管理
- [ ] **4.3.1** 定义路由表结构
- [ ] **4.3.2** 实现路由查找 (最长前缀匹配)
- [ ] **4.3.3** 实现路由增删
- [ ] **4.3.4** 单元测试: 路由匹配

### 4.4 隧道聚合根
- [ ] **4.4.1** 实现 `Tunnel` 聚合根
- [ ] **4.4.2** 集成会话 + IP + 路由
- [ ] **4.4.3** 集成测试: 隧道建立流程

---

## Phase 5: 应用层

### 5.1 配置管理
- [ ] **5.1.1** 定义配置结构 (服务端/客户端)
- [ ] **5.1.2** 实现 TOML 配置解析
- [ ] **5.1.3** 实现配置校验
- [ ] **5.1.4** 单元测试: 配置解析

### 5.2 VPN 服务端
- [ ] **5.2.1** 实现监听循环
- [ ] **5.2.2** 实现多客户端管理
- [ ] **5.2.3** 实现数据转发 (TUN <-> Raw Socket)
- [ ] **5.2.4** 实现优雅关闭
- [ ] **5.2.5** 集成测试: 服务端启停

### 5.3 VPN 客户端
- [ ] **5.3.1** 实现连接逻辑
- [ ] **5.3.2** 实现自动重连
- [ ] **5.3.3** 实现数据转发
- [ ] **5.3.4** 集成测试: 客户端连接

### 5.4 CLI
- [ ] **5.4.1** 实现服务端命令 (start/stop/status)
- [ ] **5.4.2** 实现客户端命令 (connect/disconnect)
- [ ] **5.4.3** 实现日志级别控制

---

## Phase 6: 端到端测试

- [ ] **6.1** 本地回环测试 (同机 server + client)
- [ ] **6.2** 局域网测试 (两台 Linux)
- [ ] **6.3** 跨平台测试 (Linux server + Windows client)
- [ ] **6.4** 丢包模拟测试 (tc netem)
- [ ] **6.5** 游戏联机测试 (实际游戏场景)

---

## 技术债务 & 优化

- [ ] 性能分析与优化
- [ ] 内存使用优化
- [ ] 日志完善
- [ ] 文档编写
- [ ] CI/CD 配置

---

## 当前进度

**已完成**: 6 / 89 项

**当前阶段**: Phase 1 - 基础设施层

**下一步**: 1.2.1 定义 `trait PacketSender` 接口

---

## 备注

- 每完成一个任务，将 `[ ]` 改为 `[x]`
- 遇到阻塞问题，在任务后添加 `⚠️` 标记
- 需要讨论的设计决策，添加到下方讨论区

### 设计讨论区

<!-- 在此记录需要讨论的设计问题 -->
